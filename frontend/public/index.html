<!DOCTYPE html>
<html>
<head>
  <title>AI4Pi - Pi Transactions</title>
  <meta charset="UTF-8" />
</head>
<body>
  <h1>AI4Pi - Pi Transactions</h1>
  
  <button id="loginBtn">Log in with Pi Network</button>
  <button id="sendBtn">Send Pi to AI4Pi</button>
  <button id="approvePendingBtn">Approve Pending Payment</button>
  
  <div id="logs" style="margin-top:20px; border:1px solid #ccc; padding:10px;"></div>

  <!-- 1) Load the Pi SDK FIRST -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  
  <!-- 2) Then load your app script -->
  <script>
    // Replace with your Pi Developer Key from the Pi Dev Portal
    const apiKey = "YOUR_PI_API_KEY_HERE";

    // Initialize Pi
    Pi.init({
      version: "2.0",
      appId: "YOUR_APP_ID_HERE",      // from the Dev Portal
      walletId: "YOUR_WALLET_ID_HERE", // from the Dev Portal
      sandbox: true                   // set to false for production
    });

    // A helper function to append logs to the page
    function logMessage(msg) {
      const logsEl = document.getElementById('logs');
      const p = document.createElement('p');
      p.textContent = msg;
      logsEl.appendChild(p);
      console.log(msg);
    }

    // Log in / authenticate
    function login() {
      Pi.authenticate(
        { userRoles: ["username", "payments"] },
        function(auth) {
          logMessage("Signed in as: " + auth.user.username);
        },
        function(error) {
          logMessage("Login error: " + error);
        }
      );
    }

    // Approve Payment
    function approvePaymentOnServer(paymentId) {
      return fetch(`https://api.minepi.com/v2/payments/${paymentId}/approve`, {
        method: "POST",
        headers: {
          "Authorization": `Key ${apiKey}`,
          "Content-Type": "application/json"
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          logMessage(`‚úÖ Payment ${paymentId} approved successfully.`);
        } else {
          throw new Error(data.error || "Approval failed");
        }
      })
      .catch(err => {
        logMessage(`‚ùå Error approving payment: ${err.message}`);
        throw err;
      });
    }

    // Complete Payment
    function completePaymentOnServer(paymentId, txid) {
      return fetch(`https://api.minepi.com/v2/payments/${paymentId}/complete`, {
        method: "POST",
        headers: {
          "Authorization": `Key ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ txid })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          logMessage(`‚úÖ Payment ${paymentId} completed successfully.`);
        } else {
          throw new Error(data.error || "Completion failed");
        }
      })
      .catch(err => {
        logMessage(`‚ùå Error completing payment: ${err.message}`);
        throw err;
      });
    }

    // Create and send a new payment
    function sendPayment() {
      Pi.createPayment({
        amount: 1,
        memo: "Payment to AI4Pi",
        metadata: { test: "123" }
      }, {
        onReadyForServerApproval: function(paymentId) {
          logMessage(`onReadyForServerApproval: Payment ID = ${paymentId}`);
          approvePaymentOnServer(paymentId)
            .then(() => {
              logMessage("Payment approved, waiting for blockchain confirmation...");
            })
            .catch(err => {
              logMessage("Error in approving payment: " + err.message);
            });
        },
        onReadyForServerCompletion: function(paymentId, txid) {
          logMessage(`onReadyForServerCompletion: Payment ID = ${paymentId}, TXID = ${txid}`);
          completePaymentOnServer(paymentId, txid)
            .then(() => {
              logMessage("Payment completed successfully!");
            })
            .catch(err => {
              logMessage("Error in completing payment: " + err.message);
            });
        },
        onCancel: function(paymentId) {
          logMessage(`Payment cancelled: ${paymentId}`);
        },
        onError: function(error, paymentId) {
          logMessage(`Payment error: ${error}, Payment ID: ${paymentId}`);
        }
      });
    }

    // Check for pending/stuck payments
    function checkForPendingPayments() {
      logMessage("üîç Checking for pending payments...");
      Pi.getPayment()
        .then(payment => {
          if (payment && payment.identifier) {
            logMessage(`‚ö†Ô∏è Found a pending payment: ${payment.identifier}`);
            approvePaymentOnServer(payment.identifier)
              .then(() => {
                if (payment.transaction && payment.transaction.txid) {
                  return completePaymentOnServer(payment.identifier, payment.transaction.txid);
                }
              })
              .then(() => {
                logMessage("‚úÖ Pending payment handled and completed.");
              })
              .catch(error => {
                logMessage(`‚ùå Error handling pending payment: ${error.message}`);
              });
          } else {
            logMessage("‚úÖ No pending payments found.");
          }
        })
        .catch(error => {
          logMessage(`‚ùå Error checking pending payments: ${error.message}`);
        });
    }

    // Pi‚Äôs own callback for incomplete payments
    Pi.onIncompletePaymentFound((payment) => {
      if (payment && payment.identifier) {
        logMessage(`‚ö†Ô∏è Incomplete payment found: ${payment.identifier}`);
        approvePaymentOnServer(payment.identifier)
          .then(() => {
            if (payment.transaction && payment.transaction.txid) {
              return completePaymentOnServer(payment.identifier, payment.transaction.txid);
            }
          })
          .then(() => {
            logMessage(`‚úÖ Incomplete payment ${payment.identifier} handled successfully.`);
          })
          .catch(error => {
            logMessage(`‚ùå Error handling incomplete payment: ${error.message}`);
          });
      }
    });

    // Auto-check for pending payments every 30 seconds
    setInterval(checkForPendingPayments, 30000);

    // Wire up buttons
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('sendBtn').addEventListener('click', sendPayment);
    document.getElementById('approvePendingBtn').addEventListener('click', checkForPendingPayments);
  </script>
</body>
</html>
