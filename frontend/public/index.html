<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pi Payment Flow Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 24px; }
    button { margin: 5px; padding: 10px; }
    #logs { margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>Pi Payment Flow Demo</h1>
  <button id="loginBtn">Log in with Pi Network</button>
  <button id="sendBtn">Send Pi Payment</button>
  <button id="approvePendingBtn">Check/Approve Pending Payment</button>
  <div id="logs"></div>

  <!-- Load Pi SDK first -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    // Replace with your actual API key from the Pi Developer Portal
    const apiKey = "YOUR_PI_API_KEY_HERE";

    // Initialize the Pi SDK with your App ID, Wallet ID, and sandbox flag.
    Pi.init({
      version: "2.0",
      appId: "YOUR_APP_ID_HERE",      // Your App ID
      walletId: "YOUR_WALLET_ID_HERE",  // Your Wallet ID
      sandbox: true                   // Set to true for testing; false for production
    });

    // Utility function to log messages to the UI and console
    function logMessage(message) {
      console.log(message);
      const logsDiv = document.getElementById("logs");
      const p = document.createElement("p");
      p.textContent = message;
      logsDiv.appendChild(p);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    // Login function using the Pi SDK
    function login() {
      Pi.authenticate(
        { userRoles: ["username", "payments"] },
        function(auth) {
          logMessage("Logged in as: " + auth.user.username);
        },
        function(error) {
          logMessage("Login error: " + error);
        }
      );
    }

    // Function to send a new payment using Pi.createPayment
    function sendPayment() {
      Pi.createPayment({
        amount: 1,
        memo: "Payment to AI4Pi",
        metadata: { test: "123" }
      }, {
        onReadyForServerApproval: function(paymentId) {
          logMessage("onReadyForServerApproval: Payment ID = " + paymentId);
          // Approve the payment
          approvePayment(paymentId);
        },
        onReadyForServerCompletion: function(paymentId, txid) {
          logMessage("onReadyForServerCompletion: Payment ID = " + paymentId + ", TXID = " + txid);
          // Complete the payment
          completePayment(paymentId, txid);
        },
        onCancel: function(paymentId) {
          logMessage("Payment cancelled: " + paymentId);
        },
        onError: function(error, paymentId) {
          logMessage("Payment error: " + error + ", Payment ID: " + paymentId);
        }
      });
    }

    // Approve a payment (this demo does it from the frontend)
    function approvePayment(paymentId) {
      fetch(`https://api.minepi.com/v2/payments/${paymentId}/approve`, {
        method: "POST",
        headers: {
          "Authorization": `Key ${apiKey}`,
          "Content-Type": "application/json"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          logMessage("‚úÖ Payment " + paymentId + " approved successfully.");
        } else {
          logMessage("‚ùå Approval failed: " + data.error);
        }
      })
      .catch(error => {
        logMessage("‚ùå Error approving payment: " + error.message);
      });
    }

    // Complete a payment (this demo does it from the frontend)
    function completePayment(paymentId, txid) {
      fetch(`https://api.minepi.com/v2/payments/${paymentId}/complete`, {
        method: "POST",
        headers: {
          "Authorization": `Key ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ txid: txid })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          logMessage("‚úÖ Payment " + paymentId + " completed successfully.");
        } else {
          logMessage("‚ùå Completion failed: " + data.error);
        }
      })
      .catch(error => {
        logMessage("‚ùå Error completing payment: " + error.message);
      });
    }

    // Check for pending (stuck/incomplete) payments and handle them
    function checkForPendingPayments() {
      logMessage("üîç Checking for pending payments...");
      Pi.getPayment()
      .then(payment => {
        if (payment && payment.identifier) {
          logMessage("‚ö†Ô∏è Found a pending payment: " + payment.identifier);
          // Auto-approve the pending payment
          fetch(`https://api.minepi.com/v2/payments/${payment.identifier}/approve`, {
            method: "POST",
            headers: {
              "Authorization": `Key ${apiKey}`,
              "Content-Type": "application/json"
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              logMessage("‚úÖ Payment " + payment.identifier + " auto-approved.");
              // If the payment has a txid, complete it
              if (payment.transaction && payment.transaction.txid) {
                fetch(`https://api.minepi.com/v2/payments/${payment.identifier}/complete`, {
                  method: "POST",
                  headers: {
                    "Authorization": `Key ${apiKey}`,
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({ txid: payment.transaction.txid })
                })
                .then(response => response.json())
                .then(completeData => {
                  if (completeData.success) {
                    logMessage("‚úÖ Payment " + payment.identifier + " completed successfully.");
                  } else {
                    logMessage("‚ùå Error completing payment: " + completeData.error);
                  }
                })
                .catch(error => {
                  logMessage("‚ùå Error completing payment: " + error.message);
                });
              } else {
                logMessage("‚ö†Ô∏è Payment has no txid yet. Will check again later.");
              }
            } else {
              logMessage("‚ùå Auto-approval failed: " + data.error);
            }
          })
          .catch(error => {
            logMessage("‚ùå API request failed: " + error.message);
          });
        } else {
          logMessage("‚úÖ No pending payments found.");
        }
      })
      .catch(error => {
        logMessage("‚ùå Error checking pending payments: " + error.message);
      });
    }

    // Handle any incomplete payments automatically via Pi SDK's callback
    Pi.onIncompletePaymentFound(function(payment) {
      if (payment && payment.identifier) {
        logMessage("‚ö†Ô∏è Incomplete payment found: " + payment.identifier);
        fetch(`https://api.minepi.com/v2/payments/${payment.identifier}/approve`, {
          method: "POST",
          headers: {
            "Authorization": `Key ${apiKey}`,
            "Content-Type": "application/json"
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            logMessage("‚úÖ Incomplete payment " + payment.identifier + " approved successfully.");
            if (payment.transaction && payment.transaction.txid) {
              fetch(`https://api.minepi.com/v2/payments/${payment.identifier}/complete`, {
                method: "POST",
                headers: {
                  "Authorization": `Key ${apiKey}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ txid: payment.transaction.txid })
              })
              .then(response => response.json())
              .then(completeData => {
                if (completeData.success) {
                  logMessage("‚úÖ Incomplete payment " + payment.identifier + " completed successfully.");
                } else {
                  logMessage("‚ùå Error completing incomplete payment: " + completeData.error);
                }
              })
              .catch(error => {
                logMessage("‚ùå Error completing incomplete payment: " + error.message);
              });
            } else {
              logMessage("‚ö†Ô∏è Incomplete payment has no txid yet. Will check later.");
            }
          } else {
            logMessage("‚ùå Incomplete payment approval failed: " + data.error);
          }
        })
        .catch(error => {
          logMessage("‚ùå Error in incomplete payment approval: " + error.message);
        });
      }
    });

    // Auto-check for pending payments every 30 seconds
    setInterval(checkForPendingPayments, 30000);

    // Attach event listeners to buttons
    document.getElementById("loginBtn").addEventListener("click", login);
    document.getElementById("sendBtn").addEventListener("click", sendPayment);
    document.getElementById("approvePendingBtn").addEventListener("click", checkForPendingPayments);
  </script>
</body>
</html>
