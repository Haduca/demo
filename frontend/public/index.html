<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI4Pi Short Demo</title>
  <!-- Pi Network SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 2em; }
    button { margin: 0.5em; padding: 0.7em 1em; border: none; border-radius: 4px; background: #333; color: #fff; cursor: pointer; }
    button:hover { background: #555; }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: #fff; margin: 10% auto; padding: 1em; border-radius: 8px; width: 90%; max-width: 400px; text-align: left; }
    .close { float: right; font-size: 1.2em; cursor: pointer; color: #999; }
    .close:hover { color: #666; }
    #chatBox { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 0.5em; margin-bottom: 0.5em; }
    #chatInput { width: 70%; padding: 0.4em; }
  </style>
</head>
<body>
  <h1>AI4Pi Short Demo</h1>
  <button onclick="loginWithPi()">Login with Pi</button>
  <button onclick="payWithPi()">Pay 3.14 Pi</button>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="userStatus">Unregistered User</h2>
      <div id="chatBox"></div>
      <input id="chatInput" type="text" placeholder="Type your message...">
      <button onclick="sendChat()">Send</button>
    </div>
  </div>

  <script>
    // Toggle this: true if your domain is in Testnet, false if Production
    const SANDBOX_MODE = true;
    let currentUser = null; // Will store "unregistered" or a Pi username

    // Initialize Pi SDK on page load
    window.onload = () => {
      Pi.init({ version: "2.0", sandbox: SANDBOX_MODE });
    };

    // Open chat modal
    function openModal() {
      document.getElementById("chatModal").style.display = "block";
    }
    // Close chat modal
    function closeModal() {
      document.getElementById("chatModal").style.display = "none";
    }

    // Add a message to the chat box
    function addMessage(sender, text) {
      const chatBox = document.getElementById("chatBox");
      const p = document.createElement("p");
      p.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Send chat
    function sendChat() {
      const input = document.getElementById("chatInput");
      const msg = input.value.trim();
      if (!msg) return;
      addMessage("You", msg);
      input.value = "";
      // Fake AI response
      setTimeout(() => addMessage("AI", "Echo: " + msg), 800);
    }

    // Login with Pi
    function loginWithPi() {
      alert("Initiating Pi login...");
      Pi.authenticate(["username"], (auth) => {
        if (!auth.user) {
          alert("Login failed or declined. You are unregistered.");
          currentUser = null; 
          document.getElementById("userStatus").innerText = "Unregistered User";
        } else {
          alert("Welcome, " + auth.user.username);
          currentUser = auth.user.username;
          document.getElementById("userStatus").innerText = "Logged in as " + currentUser;
        }
        openModal(); // Always open the chat modal no matter what
      }, (err) => {
        alert("Login error: " + err);
        currentUser = null; 
        document.getElementById("userStatus").innerText = "Unregistered User";
        openModal();
      });
    }

    // Pay with Pi
    function payWithPi() {
      alert("Initiating Pi payment...");
      const payment = {
        amount: 3.14,
        memo: "AI4Pi Payment",
        metadata: { sample: "data" }
      };
      Pi.createPayment(payment, {
        onReadyForServerApproval: (paymentId) => console.log("Payment ID:", paymentId),
        onReadyForServerCompletion: (paymentId, txid) => console.log("Ready for completion:", paymentId, txid),
        onSuccessfulPayment: (paymentId, txid) => alert("Payment successful! TxID: " + txid),
        onError: (error) => alert("Payment error: " + error),
        onPaymentCancel: (paymentId) => alert("Payment cancelled: " + paymentId)
      });
    }
  </script>
</body>
</html>